---
description: 总结SQL注入知识
---

# SQL注入

## SQL注入

所谓SQL注入，就是通过把SQL命令插入到Web[表单](https://baike.baidu.com/item/%E8%A1%A8%E5%8D%95/5380322)提交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。具体来说，它是利用现有应用程序，将（恶意的）SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句。 \[1\] 比如先前的很多影视网站泄露VIP会员密码大多就是通过WEB表单递交查询字符暴出的，这类表单特别容易受到[SQL注入式攻击](https://baike.baidu.com/item/SQL%E6%B3%A8%E5%85%A5%E5%BC%8F%E6%94%BB%E5%87%BB)。

### SQL注入原理

SQL注入产生需要满足两个条件：

1. 参数可控：前端传给后端内容用户是可以控制的。
2. 参数带入数据库查询：传入的参数拼接到SQL语句，并且带入数据库查询。

### MySQL相关知识点

在MySQL5.0版本之后，MySQL默认在数据库存放了一个`information_schema`的数据库，其中有如下三个表需要大家了解。

#### SCHEMATA

`SCHEMATA`表存储了用户创建的所有数据库的库名，我们可以通过查询展示这一过程。

[`SELECT`](http://localhost/phpMyAdmin4.8.5/url.php?url=https://dev.mysql.com/doc/refman/5.5/en/select.html) ``* FROM `SCHEMATA```

![SCHEMATA](../../../../.gitbook/assets/tu-pian%20%286%29.png)

记录数据库库名的字段为`SCHEMA_NAME`

#### TABLES

`TABLES` 存储了用户创建的所有数据库的库名和表名，我们可以通过查询展示这一过程。

[`SELECT`](http://localhost/phpMyAdmin4.8.5/url.php?url=https://dev.mysql.com/doc/refman/5.5/en/select.html) ``* FROM `TABLES```

![TABLES](../../../../.gitbook/assets/tu-pian%20%2811%29.png)

其中，`TABLE_SCHEMA` 记录了数据库的库名，`TABLE_NAME` 记录了表名。

 COLUMNS

`COLUMNS` 存储了用户创建的所有数据库的库名、表名和字段名，我们可以通过查询展示这一过程。

[`SELECT`](http://localhost/phpMyAdmin4.8.5/url.php?url=https://dev.mysql.com/doc/refman/5.5/en/select.html) ``* FROM `COLUMNS```

![COLUMNS](../../../../.gitbook/assets/tu-pian%20%282%29.png)

其中，`TABLE_SCHEMA` 记录了数据库的库名，`TABLE_NAME` 记录了数据库的表名，`COLUMN_NAME` 记录了数据库的字段名。

#### MySQL查询语句

`SELECT 要查询的字段名 FROM 库名.表名 WHERE 已知条件1的字段名='已知条件1的值' AND 已知条件2的字段名='已知条件2的值'` 

#### Limit

`limit` 使用格式为`limit m,n` 其中，`m` 是记录开始的位置，从`0` 开始，表示第一条记录，`n` 是取`n` 条记录，例如，`limit 0,1` 表示从第一条记录开始，取一条记录。

![LIMIT](../../../../.gitbook/assets/tu-pian%20%289%29.png)

#### 常用函数

| 函数名 | 备注 |
| :--- | :--- |
| database\(\) | 当前网站使用的数据库 |
| version\(\) | 当前MySQL的版本 |
| user\(\) | 当前MySQL的用户 |

#### 注释符

MySQL中，常见的注释符有`#` 或者`--`  \(注意空格）或者`/**/` 。

#### 内联注释

内联注释的形式：`/*!code*/` ，内联注释可以用于整个SQL语句，用来执行我们的SQL语句。

[`SELECT`](http://localhost/phpMyAdmin4.8.5/url.php?url=https://dev.mysql.com/doc/refman/5.5/en/select.html) ``* FROM `SCHEMATA` /*!UNION*/ /*!SELECT*/ 1,``[`USER`](http://localhost/phpMyAdmin4.8.5/url.php?url=https://dev.mysql.com/doc/refman/5.5/en/information-functions.html#function_user)`(),3,4,5`

![&#x5185;&#x8054;&#x6CE8;&#x91CA;](../../../../.gitbook/assets/tu-pian%20%283%29.png)

### 注入方式

#### Union注入

如下代码：

```text
if (mysqli_connect_errno())
{
	echo "连接失败: " . mysqli_connect_error();
}

$id = $_GET['id'];

$result = mysqli_query($con,"select * from user where `id`=".$id);

while($row = mysqli_fetch_array($result))
{
	echo $row['USERNAME'] . " " . $row['PASSWORD'];
	echo "<br>";
}
?>
```

这里是一个正常的查询操作，但是由于没有进行任何的过滤，将参数直接拼接到了SQL语句中，语句也未进行预处理，并且`$_GET` 参数攻击者可控，因此攻击者可以利用SQL注入漏洞对系统发起攻击。

正常访问：

![&#x6B63;&#x5E38;&#x8BBF;&#x95EE;](../../../../.gitbook/assets/tu-pian%20%2810%29.png)

在`id=1`后面添加`'` 

![1&#x2019;&#x8FD4;&#x56DE;&#x4E3A;&#x7A7A;](../../../../.gitbook/assets/tu-pian%20%288%29.png)

这里说明有可能存在SQL注入，为了进一步判别是否存在漏洞，我们要进行验证是否可以进行逻辑运算，比如我们访问`id=1 and 1=1`  ，由于`1=1` 为真，因此应返回与`id=1` 相同的页面，同样的，`id=1 and 1=2` 应返回不同的页面。

![and 1=1](../../../../.gitbook/assets/tu-pian%20%2812%29.png)

![and 1=2](../../../../.gitbook/assets/tu-pian%20%285%29.png)

因此可以判断网站存在SQL注入漏洞，我们可以通过以下过程，通过漏洞模拟攻击者获得数据库相关信息。

1. 判断数据表字段数量`order by num` 
2. 判断可输出字段`union  select 1,2,...,num`
3. 替换可显示字段，输出我们想执行操作

![order by 3 &#x663E;&#x793A;&#x6B63;&#x5E38;](../../../../.gitbook/assets/tu-pian%20%2813%29.png)

![order by 4 &#x663E;&#x793A;&#x4E0D;&#x6B63;&#x5E38;](../../../../.gitbook/assets/tu-pian%20%281%29.png)

说明一共有3个字段，接下来我们尝试哪个字段是可以输出的

![union select 1,2,3](../../../../.gitbook/assets/tu-pian.png)

说明位置`2` 和`3` 是可以输出的，替换我们想执行的操作，以`user()` 和`database()` 举例

![union select 1,user\(\),database\(\)](../../../../.gitbook/assets/tu-pian%20%284%29.png)

可以得出当前用户是`root`用户，数据表为`users` 表，我们也可以通过控制`id` 参数，给其设定一个不存在的值，让其返回`union select` 的值

![id=-1 union select 1,user\(\),database\(\)](../../../../.gitbook/assets/tu-pian%20%287%29.png)



## 参考资料

1. 《Web安全攻防 渗透测试实战指南》
2. 《PHP WEB 安全开发实战》
3. 《SQL注入攻击与防御第2版》

